# 4.5.1 Thread Pools
---
4.1절에서 멀티스레딩 웹 서버를 설명했다. 언제든지 요청을 받을 수 있는 상황에서 웹 서버는 각 요청에 대한 서비스를 위해 별도의 스레드를 생성한다. 별도의 프로세스를 생성하는 것보다 별도의 스레드를 생성하는 것이 우수하지만 멀티스레딩 서버는 잠재적인 문제를 가지고 있다. 첫 번째 이슈는 스레드가 역할을 다하면 버려질 것이라는 사실과 함께 스레드를 생성하는 시간과 관련되어 있다. 두 번째 이슈는 더 안 좋다. 동시적인 모든 스레드 요청을 새로운 스레드에서 서비스되도록 만든다면, 시스템에서 동시에 활성화되는 스레드의 수를 제한하지 않는 것이다. 제한 없는 스레드는 cpu시간이나 메모리와 같은 시스템의 자원을 고갈할 수 있다. 한 가지 해결방법은 thread pool을 사용하는 것이다.

스레드 풀의 아이디어는 프로세스 시작 시 많은 스레드를 생성하고 이들을 작업 위해 기다리는 풀에 위치시키는 것이다. 서버는 요청을 받으면 풀에 있는 스레드를 깨운다. 그리고 서비스를 위한 요청을 스레드에 보내준다. 스레드가 서비스를 완료하면 스레드는 추가 작업을 기다리기 위해 풀로 되돌아간다. 풀이 이용가능한 스레드가 없다면 서버는 스레드를 사용할 수 있을때까지 기다린다.

스레드 풀을 사용하면 다음의 이점이 있다.
1. 이미 존재하는 스레드를 이용하여 서비스하는 것은 스레드 생성을 기다리는 것보다 빠르다.
2. 스레드 풀은 한 시점에 존재하는 스레드의 수를 제한한다. 이것은 동시에 많은 스레드를 지원하지 못하는 시스템에서 중요한 부분이다.
3. 수행될 태스크를 태스크를 생성하는 mechanic으로부터 분리하는 것은 실행중인 태스크에 대한 다른 전략을 사용할 수 있게 한다. 예를 들어 태스크를 시간 지연 후에, 또는 주기적으로 실행하기 위해 태스크를 스케쥴링할 수 있다.

풀에 있는 스레드의 수는 시스템의 cpu 수, 물리적 메모리 총량, 예상되는 동시 클라이언트 수와 같은 요소들에 기반하여 실험적으로 설정될 수 있다. 더 세련된 스레드 풀 아키텍처는 풀의 사용 패턴에 따라 동적으로 스레드의 수를 조절할 수 있다. 이와 같은 아키텍처는 시스템 부하가 작을 때 더 작은 풀(더 작은 메모리를 소모하는 풀)을 가져도 되는 이점을 제공한다. 이런 다음 절에서 아키텍처 중 Apple's Grand Central Dispatch에 대해서 다룬다.

Windows API는 스레드 풀과 관련된 몇 가지 함수를 제공한다. thread pool API를 이용하는 것은 4.4.2절에서 논의한 Thread_Create() 함수로 스레드를 생성하는 것과 유사하다. 아래 별도의 스레드로서 실행되는 함수가 정의되어 있다.

    DWORD WINAPI PoolFunction(AVOID Param){
        // this function runs as a separate thread.
    }

PoolFunction()을 가리키는 포인터는 thread pool API의 함수로 전달된다. thread pool API의 멤버는 QueueUserWorkItem() 함수이다. 이 함수는 세 가지 파마리터를 전달받는다.
- LPTHREAD_START_ROUTINE Function - 별도의 스레드를 실행하기 위한 함수를 가리키는 포인터.
- PVOID Param - 함수에 전달되는 파라미터
- ULONG Flags - 어떻게 스레드 풀이 스레드의 생성과 실행 관리를 하는지 나타내는 flag.

다음은 함수 호출의 예이다.
Queue UserWorkItem(&PoolFunction, NULL 0);

이것은 스레드 풀의 스레드가 프로그래머를 대신해서 PoolFunction() 함수를 호출하게 된다. 이 경우에는, PoolFunction()으로 파라미터를 전달하지 않는다. flag가 0으로 명시되었기 때문에 스레드 생성을 위한 특별한 instruction없이 스레드 풀을 제공한다.

Windows thread pool API의 다른 멤버들은 주기적으로 또는 asynchronous I/O 요청이 완료될 때 함수를 호출하는 유틸리티을 포함한다. Java API에서도 java.util.concurrent 패키지가 스레드 풀 유틸리티를 제공한다.
